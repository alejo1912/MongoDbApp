
@{
    ViewData["Title"] = "GestionEvento";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<nav class="navbar navbar-expand-sm navbar-light bg-light" style="margin-top:67px;">
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a data-toggle="tab" class="nav-link" href="#home1">Gestión Evento</a>
            </li>

        </ul>
    </div>
</nav>
<div class="card o-hidden border-0 shadow-lg my-n2">
    <div class="tab-content">
        <br />
        @* Persona *@
        <div class="tab-pane active" id="home1">
            <form class="user" style="margin:2%">
                <div class="form-group row">
                    <div class="col-sm-3 mb-3 mb-sm-3" hidden>
                        <input type="text" class="form-control" id="idText" name="idText" placeholder="Id" required readonly>
                    </div>
                    <div class="col-sm-3 mb-3 mb-sm-3">
                        <label class="col-form-label" name="Encuentro"><span style="color:red">*</span>Encuentro</label>
                        <input type="text" class="form-control" id="Encuentro" name="Encuentro" placeholder="Nombre Encuentro">
                    </div>
                    <div class="col-sm-3 mb-3 mb-sm-3">
                        <label class="col-form-label" name="idTemporada">Temporada-Campeonato</label>
                        <select id="idTemporada" name="idTemporada" class="form-control bg-white collapse-inner" required style="width:100%;color:blue;">
                            <option value="" class="col-sm-3 mb-3 mb-sm-3">Seleccione el Equipo </option>
                        </select>
                    </div>
                    <div class="col-sm-3 mb-3 mb-sm-3">
                        <label class="col-form-label" name="idEquipoA">Equipo A</label>
                        <select id="idEquipoA" name="idEquipoA" class="form-control-lg bg-white collapse-inner" required style="width:100%;color:blue;">
                            <option value="" class="col-sm-3 mb-3 mb-sm-3">Seleccione el Equipo </option>
                        </select>
                    </div>
                    <div class="col-sm-3 mb-3 mb-sm-3">
                        <label class="col-form-label" name="idEquipoB">Equipo B</label>
                        <select id="idEquipoB" name="idEquipoB" class="form-control bg-white collapse-inner" required style="width:100%;color:blue;">
                            <option value="" class="col-sm-3 mb-3 mb-sm-3">Seleccione el Equipo </option>
                        </select>
                    </div>
                    <div class="col-sm-3 mb-3 mb-sm-3">
                        <label class="col-form-label" name="idArbitro">Árbitro</label>
                        <select id="idArbitro" name="idArbitro" class="form-control bg-white collapse-inner" required style="width:100%;color:blue;">
                            <option value="" class="col-sm-3 mb-3 mb-sm-3">Seleccione el Árbitro </option>
                        </select>
                    </div>
                    <hr style="width:100%;color:blue;" />
                    <div class="form-group row col-sm-12 mb-12 mb-sm-12">
                        <h5 style="text-align:center" class="col-sm-12 mb-12 mb-sm-12">Marcador</h5>
                        <div class="col-sm-3 mb-3 mb-sm-3">
                            <label class="col-form-label" name="idEquipoB">Equipo</label>
                            <select id="idEquipo" name="idEquipo" class="form-control bg-white collapse-inner" required style="width:100%;color:blue;">
                                <option value="" class="col-sm-3 mb-3 mb-sm-3">Seleccione el Equipo </option>
                            </select>
                        </div>
                        <div class="col-sm-3 mb-3 mb-sm-3">
                            <label class="col-form-label" name="idEquipoB">Jugador</label>
                            <select id="idDeportista" name="idDeportista" class="form-control bg-white collapse-inner" required style="width:100%;color:blue;">
                                <option value="" class="col-sm-3 mb-3 mb-sm-3">Seleccione el Equipo </option>
                            </select>
                        </div>
                        <div class="col-sm-3 mb-3 mb-sm-3">
                            <label class="col-form-label" name="goles"><span style="color:red">*</span>Gol</label>
                            <input type="number" max="100" class="form-control" id="goles" name="goles" placeholder="goles">
                        </div>
                        <div class="col-sm-3 mb-3 mb-sm-3">
                            <label class="col-form-label" name="btnAdd">.</label>
                            <button type="button" class="form-control btn-secondary" id="btnAdd" placeholder="Add" style="background: #4e73df;font-size:15px;color:white;">Anotar</button>
                        </div>
                    </div>
                    <div class="col-sm-3 mb-3 mb-sm-3">
                        <label class="col-form-label" name="btnCrear">.</label>
                        <button type="button" class="form-control btn-secondary" id="btnCrear" placeholder="Guardar" style="background: #4e73df;font-size:15px;color:white;">Guardar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<script>

    var update = false;
    var idText = "";
    var idEquipoA = "";
    var idEquipoB = "";
    var idTemporada = "";
    var idArbitro = "";
    var ListResultados = [];
    $(document).ready(function () {
        getEvento();
        $("#idEquipoA").select2();
        $("#idEquipoB").select2();
        $("#idTemporada").select2();
        $("#idArbitro").select2();
        DropListEquipos();
        DropListTemporadas();
        DropListArbitro();
        DropListJugador();
    });

    $("#btnAdd").click(function Add() {
        debugger
        var idEquipo = $("#idEquipo").val();
        var idDeportista = $("#idDeportista").val();
        var goles = parseInt($("#goles").val());

        var objIndex = ListResultados.findIndex((obj => obj.idEquipo == idEquipo && obj.idDeportista == idDeportista));
        //Update object's goles property.
        if (objIndex >=0) {
            ListResultados[objIndex].goles += goles;
        }
        else {
            debugger
            b = { idEquipo: idEquipo, idDeportista: idDeportista, goles: goles };
            ListResultados.push(b);
        }
    });


    $("#btnCrear").click(function () {


        //var ListResultados = [
        //    { idEquipo: "123EWQEW", idDeportista: "321312", goles: 2 },
        //    { idEquipo: "2132332", idDeportista: "23232", goles: 1 },
        //];
        var data = {
            idTex: idText,
            idTemporada: $("#idTemporada").val(),
            idEquipoA: $("#idEquipoA").val(),
            idEquipoB: $("#idEquipoB").val(),
            idArbitro: $("#idArbitro").val(),
            Encuentro: $("#Encuentro").val(),
            listResultados: ListResultados
        }
        debugger
        var entidad = JSON.stringify(data);
        if (update == false) {
            $.ajax({
                url: 'https://localhost:44331/api/EventosDeportivos/CreateEncuentrosDeportivo',
                'type': 'POST',
                data: entidad,
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                traditional: true,
                async: true,
                dataType: "JSON",
                success: function (ok) {
                    if (ok) {
                        toastr.success("success");
                    } else {
                        toastr.warning(ok.mensaje);
                    }
                },
                complete: function () {

                },
                error: function (data) {
                    toastr.error("No pudimos completar tu solicitud!");
                }
            });
        }
        else if (idText != "" && idText != undefined && idText != NaN) {
            $.ajax({
                url: 'https://localhost:44331/api/EventosDeportivos/UpdateEncuentrosDeportivo',
                'type': 'PUT',
                data: entidad,
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                traditional: true,
                async: true,
                dataType: "JSON",
                success: function (ok) {
                    if (ok) {
                        toastr.success("success");
                    } else {
                        toastr.warning(ok.mensaje);
                    }
                },
                complete: function () {

                },
                error: function (data) {
                    toastr.error("No pudimos completar tu solicitud!");
                }
            });
        }
        else {
            toastr.warning("selecciona una accion!");
        }
    });

    function getEvento() {
        var id = '@ViewBag.idString';
        debugger
        if (id != "" && id != undefined && id != NaN) {
            var uri = 'https://localhost:44331/api/EventosDeportivos/GetEncuentrosDeportivoById';
            var url = uri + '?' + $.param({ "id": id });
            $.ajax({
                url: url,
                type: 'get',
                success: function (data) {
                    debugger
                    $("#idText").val("");
                    $("#idEquipoA").val("");
                    $("#idEquipoB").val("");
                    $("#idTemporada").val("");
                    $("#idArbitro").val("");
                    $("#Encuentro").val("");

                    if (data.response.ok) {
                        toastr.success(data.response.message);
                        update = true;

                        idText = data.evento.idTex;
                        $("#idText").val(data.evento.idTex);
                        $("#Encuentro").val(data.evento.Encuentro);
                        $("#idEquipoA").val(data.evento.idEquipoA);
                        idEquipoA=data.evento.idEquipoA;
                        $("#idEquipoB").val(data.evento.idEquipoB);
                        idEquipoB=data.evento.idEquipoB;
                        $("#idTemporada").val(data.evento.idTemporada);
                        idTemporada=data.evento.idTemporada;
                        $("#idArbitro").val(data.evento.idArbitro);
                        idArbitro=data.evento.idArbitro;

                    } else {
                        toastr.warning("No pudimos procesar su Solicitud!");
                    };
                },
                error: function (jQXHR) {
                    toastr.error('error, No pudimos procesar su Solicitud!');
                }
            });
        }
    };

    function DropListEquipos() {
        $.ajax({
            url: 'https://localhost:44331/api/Equipos/GetAllListEquipos',
            method: 'get',
            traditional: true,
            async: true,
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            headers: {
                'Authorization': 'Bearer '
                    + localStorage.getItem("accessToken")
            },
            success: function (data) {
                //A
                $('#idEquipoA').empty();
                
                if (data.ok) {
                    $(data.equipos).each(function (i) {
                        $('#idEquipoA').append($('<option>', {
                            value: data.equipos[i].idTex,
                            text: data.equipos[i].nombreEquipo,
                        }));
                    });
                    if (idEquipoA != "") {
                        $("#idEquipoA").val(idEquipoA).trigger('change.select2');
                    }
                } else {
                    toastr.warning(data.mensaje);
                }
                ///B
                $('#idEquipoB').empty();
                
                if (data.ok) {
                    $(data.equipos).each(function (i) {
                        $('#idEquipoB').append($('<option>', {
                            value: data.equipos[i].idTex,
                            text: data.equipos[i].nombreEquipo,
                        }));
                    });
                    if (idEquipoB != "") {
                        $("#idEquipoB").val(idEquipoB).trigger('change.select2');
                    }
                } else {
                    toastr.warning(data.mensaje);
                }

                ///Add
                $('#idEquipo').empty();

                if (data.ok) {
                    $(data.equipos).each(function (i) {
                        $('#idEquipo').append($('<option>', {
                            value: data.equipos[i].idTex,
                            text: data.equipos[i].nombreEquipo,
                        }));
                    });
                } 
            },
            error: function (data) {
                toastr.error("error");
            }
        });
    }

    function DropListTemporadas() {
        $.ajax({
            url: 'https://localhost:44331/api/Temporadas/GetAllListTemporadas',
            method: 'get',
            traditional: true,
            async: true,
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            headers: {
                'Authorization': 'Bearer '
                    + localStorage.getItem("accessToken")
            },
            success: function (data) {
                $('#idTemporada').empty();
                
                if (data.ok) {
                    $(data.temporadas).each(function (i) {
                        $('#idTemporada').append($('<option>', {
                            value: data.temporadas[i].idTex,
                            text: data.temporadas[i].temporada,
                        }));
                    });
                    if (idTemporada != "") {
                        $("#idTemporada").val(idTemporada).trigger('change.select2');
                    }
                } else {
                    toastr.warning(data.mensaje);
                }
            },
            error: function (data) {
                toastr.error("error");
            }
        });
    }

    function DropListArbitro() {
        $.ajax({
            url: 'https://localhost:44331/api/Arbitros/GetAllListArbitros',
            method: 'get',
            traditional: true,
            async: true,
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            headers: {
                'Authorization': 'Bearer '
                    + localStorage.getItem("accessToken")
            },
            success: function (data) {
                $('#idArbitro').empty();
                
                if (data.ok) {
                    $(data.arbitros).each(function (i) {
                        $('#idArbitro').append($('<option>', {
                            value: data.arbitros[i].idTex,
                            text: data.arbitros[i].nombre,
                        }));
                    });
                    if (idArbitro != "") {
                        $("#idArbitro").val(idArbitro).trigger('change.select2');
                    }
                } else {
                    toastr.warning(data.mensaje);
                }
            },
            error: function (data) {
                toastr.error("error");
            }
        });
    }

    function DropListJugador() {
        $.ajax({
            url: 'https://localhost:44331/api/Deportistas/GetAllListDeportistas',
            method: 'get',
            traditional: true,
            async: true,
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                $('#idDeportista').empty();
                debugger
                if (data.ok) {
                    $(data.deportistas).each(function (i) {
                        $('#idDeportista').append($('<option>', {
                            value: data.deportistas[i].idTex,
                            text: data.deportistas[i].nombre,
                        }));
                    });

                } 
            },
            error: function (data) {
                toastr.error("error");
            }
        });
    }

</script>



